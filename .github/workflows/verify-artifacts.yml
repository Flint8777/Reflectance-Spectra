name: Verify Build Artifacts

on:
  workflow_run:
    workflows: ["Release builds (Windows & macOS)"]
    types:
      - completed

permissions:
  contents: read

jobs:
  verify-windows:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: windows-latest
    steps:
      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-portable-dist
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Extract and verify
        shell: powershell
        run: |
          $zip = Get-ChildItem -Filter "*.zip" | Select-Object -First 1
          if ($zip) {
            Write-Host "Found: $($zip.Name)"
            Expand-Archive -Path $zip.FullName -DestinationPath "extracted"
            $exe = Get-ChildItem -Path "extracted" -Recurse -Filter "*.exe" | Select-Object -First 1
            if ($exe) {
              Write-Host "Executable found: $($exe.FullName)"
              # 起動テスト（5秒後に強制終了）
              $proc = Start-Process -FilePath $exe.FullName -PassThru -WindowStyle Hidden
              Start-Sleep -Seconds 5
              if (!$proc.HasExited) {
                Write-Host "✅ App started successfully"
                Stop-Process -Id $proc.Id -Force
              } else {
                Write-Host "❌ App crashed immediately"
                exit 1
              }
            } else {
              Write-Host "❌ Executable not found"
              exit 1
            }
          } else {
            Write-Host "❌ ZIP file not found"
            exit 1
          }

  verify-macos-x64:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: macos-13
    steps:
      - name: Download macOS x64 artifact
        uses: actions/download-artifact@v4
        with:
          name: mac-x64-dist
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Extract and verify
        run: |
          zip_file=$(find . -name "*.zip" -type f | head -n1)
          if [ -n "$zip_file" ]; then
            echo "Found: $zip_file"
            unzip -q "$zip_file"
            app=$(find . -name "*.app" -type d | head -n1)
            if [ -n "$app" ]; then
              echo "App found: $app"
              # 起動テスト（5秒後に強制終了）
              open "$app" &
              APP_PID=$!
              sleep 5
              if ps -p $APP_PID > /dev/null; then
                echo "✅ App started successfully"
                kill $APP_PID 2>/dev/null || true
              else
                echo "❌ App crashed immediately"
                exit 1
              fi
            else
              echo "❌ .app bundle not found"
              exit 1
            fi
          else
            echo "❌ ZIP file not found"
            exit 1
          fi

  verify-macos-arm64:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: macos-14
    steps:
      - name: Download macOS arm64 artifact
        uses: actions/download-artifact@v4
        with:
          name: mac-arm64-dist
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Extract and verify
        run: |
          zip_file=$(find . -name "*.zip" -type f | head -n1)
          if [ -n "$zip_file" ]; then
            echo "Found: $zip_file"
            unzip -q "$zip_file"
            app=$(find . -name "*.app" -type d | head -n1)
            if [ -n "$app" ]; then
              echo "App found: $app"
              # 起動テスト（5秒後に強制終了）
              open "$app" &
              APP_PID=$!
              sleep 5
              if ps -p $APP_PID > /dev/null; then
                echo "✅ App started successfully"
                kill $APP_PID 2>/dev/null || true
              else
                echo "❌ App crashed immediately"
                exit 1
              fi
            else
              echo "❌ .app bundle not found"
              exit 1
            fi
          else
            echo "❌ ZIP file not found"
            exit 1
          fi
